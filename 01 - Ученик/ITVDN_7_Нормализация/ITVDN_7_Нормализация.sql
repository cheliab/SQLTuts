-- 7. Нормализация

create database ITVDN_7_Normalization
go

use ITVDN_7_Normalization
go

------------------------------------------------------------------------
-- Первая нормальная форма

create table PizzeriaData(
	OrderNo int,
	[Date] date,
	Customer nvarchar(100),
	CustomerData nvarchar(max),
	OrderInfo nvarchar(max),
	Courier nvarchar(100)
)
go

insert PizzeriaData
values
(1, '20170407', 'Березкин Павел', 'ул. Спортивная, д. 12, тел. 55-66-77', 'пицца Пеперони - 1, пиво Асахи - 2 (0.5)', 'Дмитирий Зорченко'),
(2, '20170407', 'Соловейкин Петр', 'ул. Ленина, д. 30, тел. 11-22-33', 'пицца Мексиканская - 2, Салат цезарь - 2, Сок апельсиновый - 1', 'Вова'),
(3, '20170407', 'Драгомиров Владимир', 'ул. Есенина, д. 20, тел. 45-67-89, моб. (077)555-11-41', 'пиво Балтика 3 - 6 (1), Картошка фри - 3, Сырные шарики - 2', 'Санек (Разрушитель)')
go

select * from PizzeriaData

---------------------------------------------------------
-- Изменяем таблицу
-- Разбиваем списки внутри столбцов на отдельные столбцы

drop table PizzeriaData

create table PizzeriaData(
	OrderNo int,
	[Date] date,
	Customer nvarchar(100),
	CustomerAddress nvarchar(max),
	CustomerPhone varchar(15),
	CustomerMob varchar(15),
	Product1 nvarchar(20),
	Qty1 tinyint,
	Product2 nvarchar(20),
	Qty2 tinyint,
	Product3 nvarchar(20),
	Qty3 tinyint,
	Courier nvarchar(100)
)
go

insert PizzeriaData
values
(1, '20170407', 'Березкин Павел', 'ул. Спортивная, д. 12', 'тел. 55-66-77', null, 'пицца Пеперони', 1, 'пиво Асахи (0.5)', 2, null, null, 'Дмитирий Зорченко'),
(2, '20170407', 'Соловейкин Петр', 'ул. Ленина, д. 30', 'тел. 11-22-33',  null, 'пицца Мексиканская', 2, 'Салат цезарь', 2, 'Сок апельсиновый', 1, 'Вова'),
(3, '20170407', 'Драгомиров Владимир', 'ул. Есенина, д. 20', 'тел. 45-67-89', 'моб. (077)555-11-41', 'пиво Балтика 3 (1)', 6, 'Картошка фри', 3, 'Сырные шарики', 2, 'Санек (Разрушитель)')
go

----------------------------------------
-- Изменяем таблицу
-- сделаем правильные колонки для заказываемого продукта
-- чтобы устранить дублировние колонок

drop table PizzeriaData

create table PizzeriaData (
	OrderNo int,
	OrderItem int,
	[Date] date,
	Customer nvarchar(100),
	CustomerAddress nvarchar(max),
	CustomerPhone varchar(15),
	CustomerMob varchar(15),
	Product nvarchar(20),
	ProductName nvarchar(20),
	Qty tinyint,
	Courier nvarchar(100)
)

insert PizzeriaData
values
(1, 1, '20170407', 'Березкин Павел', 'ул. Спортивная, д. 12', 'тел. 55-66-77', null, 'пицца', 'Пеперони', 1, 'Дмитирий Зорченко'),
(1, 2, '20170407', 'Березкин Павел', 'ул. Спортивная, д. 12', 'тел. 55-66-77', null, 'пиво', 'Асахи (0.5)', 2, 'Дмитирий Зорченко'),
(2, 1, '20170407', 'Соловейкин Петр', 'ул. Ленина, д. 30', 'тел. 11-22-33',  null, 'пицца', 'Мексиканская', 2, 'Вова'),
(2, 2, '20170407', 'Соловейкин Петр', 'ул. Ленина, д. 30', 'тел. 11-22-33',  null, 'салат', 'Цезарь', 2, 'Вова'),
(2, 3, '20170407', 'Соловейкин Петр', 'ул. Ленина, д. 30', 'тел. 11-22-33',  null, 'сок апельсиновый', 'Rich', 1, 'Вова'),
(3, 1, '20170407', 'Драгомиров Владимир', 'ул. Есенина, д. 20', '45-67-89', '(077)555-11-41', 'пиво', 'Балтика 3 (1)', 6, 'Санек (Разрушитель)'),
(3, 2, '20170407', 'Драгомиров Владимир', 'ул. Есенина, д. 20', '45-67-89', '(077)555-11-41', 'закуски', 'Картошка фри', 3, 'Санек (Разрушитель)'),
(3, 3, '20170407', 'Драгомиров Владимир', 'ул. Есенина, д. 20', '45-67-89', '(077)555-11-41', 'закуски', 'Сырные шарики', 2, 'Санек (Разрушитель)')
go

select * from PizzeriaData
where CustomerAddress like '%Спортивная%'

------------------------------------------------------------------------
------------------------------------------------------------------------
-- Вторая нормальная форма
--
-- Все не ключевые стобцы должны зависеть от ключа
-- Составной первичный ключ состоит из OrderNo и OrderItem
-- 
-- Разбиваем таблицу на три, чтобы уменьшить дублирование данных

drop table PizzeriaData

create table Orders(
	OrderNo int,
	[Date] date,
	CustomerId int,
	Courier nvarchar(100)
)

create table OrderInfo(
	OrderNo int,
	OrderItem int,
	Product nvarchar(20),
	ProductName nvarchar(20),
	Qty tinyint
)

create table Customers(
	Id int,
	FullName nvarchar(100),
	[Address] nvarchar(max),
	[Phone] varchar(15),
	[MobilePhone] varchar(15)
)

-----------

insert Orders values
(1, '20170407', 1, 'Дмитирий Зорченко'),
(2, '20170407', 2, 'Вова'),
(3, '20170408', 3, 'Санек (Разрушитель)')
go

insert OrderInfo values
(1, 1, 'пицца', 'Пеперони', 1),
(1, 2, 'пиво', 'Асахи (0.5)', 2),
(2, 1, 'пицца', 'Мексиканская', 2),
(2, 2, 'салат', 'Цезарь', 2),
(2, 3, 'сок апельсиновый', 'Rich', 1),
(3, 1, 'пиво', 'Балтика 3 (1)', 6),
(3, 2, 'закуски', 'Картошка фри', 3),
(3, 3, 'закуски', 'Сырные шарики', 2)
go

insert Customers values
(1, 'Березкин Павел', 'ул. Спортивная, д. 12', 'тел. 55-66-77', null),
(2, 'Соловейкин Петр', 'ул. Ленина, д. 30', 'тел. 11-22-33', null),
(3, 'Драгомиров Владимир', 'ул. Есенина, д. 20', '45-67-89', '(077)555-11-41')
go

select * from Orders

select * from OrderInfo

select * from Customers

------------------------------------------------
-- Третья нормальная форма
--
-- Устранение транзитивной зависимости не ключевых колонок
-- т.е. в таблице все колонки должны быть напрямую зависеть от ключа, а не через другую колонку

-- Сотрудники
create table Employees(
	Id int,
	FullName nvarchar(200),
	Position nvarchar(20),
	Salary decimal(9,4) -- Зарплата транзитивно зависит от должности
)
go

insert Employees values
(1, 'Павел Морозов', 'курьер', 1000.00),
(2, 'Дмитрий Шевелев', 'курьер', 1000.00),
(3, 'Александр Галов', 'менеджер', 2000.00),
(4, 'Анна Лобанова', 'бухгалтер', 1500.00)
go

select * from Employees

-----------------------------------
-- Чтобы убрать транзитивную зависимость разбиваем таблицу с сотрудниками на 2

drop table Employees
go

create table Employees(
	Id int,
	FullName nvarchar(100),
	PositionId int
);
go

insert Employees values
(1, 'Павел Морозов', 1),
(2, 'Дмитрий Шевелев', 1),
(3, 'Александр Галов', 2),
(4, 'Анна Лобанова', 3)
go

create table Salaries (
	Id int,
	Position nvarchar(100),
	Rate decimal(9,4)
)
go

insert Salaries values
(1, 'курьер', 1000.00),
(2, 'менеджер', 2000.00),
(3, 'бухгалтер', 1500.00)
go

select * from Employees
go

select * from Salaries
go

select * from Employees
join Salaries on Employees.PositionId = Salaries.Id
go